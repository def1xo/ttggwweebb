#!/usr/bin/env python3
"""
scripts/set_admin_password.py

Устанавливает/сбрасывает пароль admin по telegram_id.
Usage:
    # установить/обновить пароль
    python scripts\set_admin_password.py --telegram-id 1901059519 --password "MyStrongPass!"
    # удалить пароль (пустая строка)
    python scripts\set_admin_password.py --telegram-id 1901059519 --password ""
"""
import os
from dotenv import load_dotenv
load_dotenv()


import argparse
import os
import sys
from pathlib import Path
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from datetime import datetime

# --- Make sure project root is in sys.path so "backend" package imports work
THIS_FILE = Path(__file__).resolve()
PROJECT_ROOT = THIS_FILE.parents[1]  # backend/.. -> project root
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

# Now import backend models & utils
try:
    from backend.app import models  # adapt if your package layout differs
    from backend.app.utils.security import hash_password
except Exception as e:
    print("ERROR: cannot import backend.app modules. Check that this script is placed in backend/scripts and that backend package is available.")
    raise

def get_database_url():
    # Prefer env DATABASE_URL, fallback to common local default
    return os.getenv("DATABASE_URL") or os.getenv("DATABASE_URL_BACKUP") or "postgresql://tgweb:changeme@localhost:5432/tgweb"

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--telegram-id", type=int, required=True, help="Telegram ID of the admin user")
    parser.add_argument("--password", type=str, required=True, help="Password to set; empty string to remove")
    args = parser.parse_args()

    DATABASE_URL = get_database_url()
    engine = create_engine(DATABASE_URL)
    SessionLocal = sessionmaker(bind=engine)
    db = SessionLocal()

    try:
        user = db.query(models.User).filter(models.User.telegram_id == args.telegram_id).first()
        if not user:
            print(f"User with telegram_id={args.telegram_id} not found. Creating new admin user...")
            # Try to infer required model fields; adjust if your User model needs different args
            user = models.User(
                telegram_id=args.telegram_id,
                first_name="Admin",
                username=None,
                role="admin",
                balance=0,
                created_at=datetime.utcnow()
            )
            db.add(user)
            db.commit()
            db.refresh(user)
            print(f"Created user id={user.id}, telegram_id={user.telegram_id}")

        if args.password == "":
            user.password_hash = None
            print("Password cleared (removed).")
        else:
            user.password_hash = hash_password(args.password)
            print("Password set/updated.")

        # Ensure role is admin
        user.role = "admin"
        db.add(user)
        db.commit()
        print(f"Done. user.id={user.id}, telegram_id={user.telegram_id}, role={user.role}")

    except Exception as exc:
        print("ERROR during DB operation:", exc)
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    main()